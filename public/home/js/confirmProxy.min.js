ec.pkg("ec.order.proxy");ec.load("ajax");ec.load("ec.box");ec.load("ec.dh");ec.load("ec.aes");ec.load("ec.rc4");var allProxyCouponCache={};var cache_proxyCoupon_by_inputCode=null;ec.order.proxy.addCouponOnly=function(a){$("#coupon-code-div"+a).hide();$("#couponCodeProxy-report-errors-"+a).removeClass("report-errors").html("");var b=$.trim($("#couponCodeOnly-"+a).val());if(!b||b.length<5||b.length>25){$("#couponCodeProxy-report-errors-"+a).addClass("report-errors").html("\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u4f18\u60e0\u5238\u7f16\u7801");return false}ec.order.proxy.addCoupon(a+"|"+b,{type:"couponcode",shopCode:a,errorFunction:function(c){if(c=="order.coupon.used.repeatedly"){c="\u4f18\u60e0\u5238\u5df2\u88ab\u4f7f\u7528\uff01"}$("#couponCodeProxy-report-errors-"+a).addClass("report-errors").html(c);$("#code_use_coupon_btn_"+a).addClass("disabled")},successFunction:function(){$("#code_use_coupon_btn_"+a).removeClass("disabled");$(".order-roll-explain").each(function(){if($(this).height()>18){$(this).addClass("order-roll-explain-more");$(this).children("a").removeClass("hide");$(this).bind("click",function(){if($(this).attr("class").indexOf("order-roll-explain-open")==-1){$(this).addClass("order-roll-explain-open")}else{$(this).removeClass("order-roll-explain-open")}})}})},})};ec.order.proxy.addCoupon=function(c,b){b=b||{};var a=$("#order-confirm-form");var e=$("input[name=orderReq]",a).val();var d="";$("input[id^='proxyCoupon']").each(function(){var f=$(this).val().split("|");if(f[0]!=b.shopCode){if(d==""){d=$(this).val()}else{d=d+"#"+$(this).val()}}});if(d==""){d=c}else{d=d+"#"+c}new ec.ajax().submit({url:"/order/coupon/queryProxyCoupon.json",timeout:10000,data:{couponCode:d,orderReqJson:e},timeoutFunction:function(){ec.order.proxy.ecboxOpen("\u64cd\u4f5c\u8d85\u65f6\uff0c\u8bf7\u91cd\u8bd5\uff01")},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(f){if(f.success){if(b.type&&"couponcode"==b.type){ec.order.proxy.couponRender(c,f,b.shopCode);if(b.successFunction){b.successFunction()}}else{if(b.couponData){var g=b.couponData.split("|")[0]+"|"+b.couponData.split("|")[1]+"|"+f[b.shopCode].couponDeduct;$("#coupon-first-"+b.shopCode).val(b.shopCode+"|"+g)}ec.order.proxy.showMsg(c,b,f)}}else{var h=f.msg||"\u4f18\u60e0\u5238\u7f16\u7801\u9519\u8bef\u3002";ec.order.proxy.resetCoupon(b.shopCode);ec.order.proxy.couponNotUse(b.shopCode);if(b.errorFunction){b.errorFunction(h)}else{if(!b.init){ec.order.proxy.ecboxOpen(h)}}}}});return false};ec.order.proxy.showMsg=function(f,c,d){if(f==null||f==""){$("#proxyCoupon"+c.shopCode).val("");$("#coupon-first-"+c.shopCode).val("");$("#coupon-info-desc-"+c.shopCode).html("");$("#order-price-"+c.shopCode).html(parseFloat(d[c.shopCode].totalPrice).toFixed(2))}else{if(c.type&&"coupon"==c.type){var a=c.shopCode;var b=$("#coupon-first-"+a).val();var g=b.split("|");var e="<span>"+g[2]+"</span>\uff0c<b>-&yen;<span>"+parseFloat(d[a].couponDeduct).toFixed(2)+"</span></b>";$("#coupon-info-desc-"+c.shopCode).html(e);$("#order-price-"+g[0]).html(parseFloat(d[a].totalPrice).toFixed(2));$("#proxyCoupon"+c.shopCode).val(g[0]+"|"+g[1])}}ec.order.newCount();ec.order.proxy.refreshCouponList(d);if(c.successFunction){c.successFunction()}};ec.order.proxy.refreshCouponList=function(a){var b=$("#order-shopCodes").val().split("|");$.each(b,function(j,m){if(m!=undefined&&m!=""&&m!="VMALL-HUAWEIDEVICE"){var d=a[m].effectiveList||[];var f=a[m].invalidList||[];var h=[];if(d){for(var g in d){effCouponInfo=d[g];if(!effCouponInfo||!effCouponInfo.couponCode){continue}var n="";var e="";var k="";if(effCouponInfo.ruleType==1&&effCouponInfo.deliveryFree==0){e="<span>"+effCouponInfo.amount+"</span><strong>\u4f18\u60e0\u5238</strong>";k="<em>&yen;</em>"}else{if(effCouponInfo.ruleType==2&&effCouponInfo.deliveryFree==0){n=" order-roll-discount";e="<span>"+effCouponInfo.discount*10+"</span><b>\u6298</b>"}else{n=" order-roll-type";e="<span>\u514d\u90ae\u5238</span>"}}var c=$("#proxyCoupon"+m).val().split("|")[1];if(c==effCouponInfo.couponCode){n=n+" current"}h.push(' <li id="'+effCouponInfo.couponCode+'" name ="'+m+"effCouponInfo_"+g+'" index="'+m+"effCouponInfo_"+g+'" data="'+effCouponInfo.couponCode+"|"+effCouponInfo.couponName+"|"+effCouponInfo.amount+'" ');h.push('class="order-roll-detail'+n+'" onclick="ec.order.proxy.couponSelected(\''+effCouponInfo.couponCode+"','"+m+"' );\"> ");h.push('     <div class="order-roll-info"> ');h.push(k);h.push('         <div class="order-roll-price clearfix"> ');h.push(e);h.push("         </div> ");h.push('         <p title="'+effCouponInfo.couponName+'" class="order-roll-word">'+effCouponInfo.couponName+"</p> ");h.push("    </div> ");h.push('<p class="order-roll-explain">\u4f7f\u7528\u8981\u6c42\uff1a'+effCouponInfo.beginDate.substring(0,10).replaceAll("-",".")+" - "+effCouponInfo.endDate.substring(0,10).replaceAll("-","."));if(effCouponInfo.couponDes!=null&&effCouponInfo.couponDes!=""&&effCouponInfo.couponDes!=undefined){h.push("\uff0c"+effCouponInfo.couponDes+'<a href="javascript:;" class="btn"></a></p>')}else{h.push('<a href="javascript:;" class="btn"></a></p>')}h.push(" </li> ")}}if(f){for(var g in f){effCouponInfo=f[g];if(!effCouponInfo||!effCouponInfo.couponCode){continue}var n="";var e="";var k="";if(effCouponInfo.ruleType==1&&effCouponInfo.deliveryFree==0){e="<span>"+effCouponInfo.amount+"</span><strong>\u4f18\u60e0\u5238</strong>";k="<em>&yen;</em>"}else{if(effCouponInfo.ruleType==2&&effCouponInfo.deliveryFree==0){n=" order-roll-discount";e="<span>"+effCouponInfo.discount*10+"</span><b>\u6298</b>"}else{n=" order-roll-type";e="<span>\u514d\u90ae\u5238</span>"}}h.push(' <li id="'+effCouponInfo.couponCode+'" class="order-roll-detail disabled'+n+'"> ');h.push('   <div class="order-roll-info"> ');h.push(k);h.push(' 	<div class="order-roll-price clearfix"> ');h.push(e);h.push("     </div> ");h.push('   <p title="'+effCouponInfo.couponName+'" class="order-roll-word">'+effCouponInfo.couponName+"</p> ");h.push("   </div> ");h.push('<p class="order-roll-explain">\u4f7f\u7528\u8981\u6c42\uff1a'+effCouponInfo.beginDate.substring(0,10).replaceAll("-",".")+" - "+effCouponInfo.endDate.substring(0,10).replaceAll("-","."));if(effCouponInfo.couponDes!=null&&effCouponInfo.couponDes!=""&&effCouponInfo.couponDes!=undefined){h.push("\uff0c"+effCouponInfo.couponDes+'<a href="javascript:;" class="btn"></a></p>')}else{h.push('<a href="javascript:;" class="btn"></a></p>')}h.push(" </li> ")}}var h='<ul class="clearfix">'+h.join(" ")+"</ul>";var l=[];l.push(" <!--20170728-\u4f18\u60e0\u5238-start --> ");l.push(' <div class="order-roll"> ');l.push('     <div class="order-roll-tab"> ');l.push('        <a href="javascript:;" class="current" id="coupon_tab_'+m+"\" onclick=\"ec.order.proxy.couponTabChange('coupon_tab','"+m+"');\">\u4f18\u60e0\u5238</a>");l.push('         <a href="javascript:;" id="coupon_code_tab_'+m+"\" onclick=\"ec.order.proxy.couponTabChange('coupon_code_tab','"+m+"');\">\u4f18\u60e0\u5238\u7801</a>");l.push("     </div> ");l.push("     <!--\u4f18\u60e0\u5238\u5217\u8868start--> ");l.push('     <div id="order-roll-coupon-'+m+'"> ');l.push('         <div class="order-roll-con"> ');if(d.length<1&&f.length<1){l.push('         	<div class="order-roll-empty" id="coupon-is-empty">\u6682\u65e0\u4f18\u60e0\u5238</div> ')}else{if(d.length<1){l.push('         	<div class="order-roll-tip" id="coupon-not-available">\u6682\u65e0\u53ef\u7528\u5238</div> ')}}l.push('         	<div class="order-roll-list" >'+h+"</div> ");l.push("         </div> ");l.push('         <div class="box-button"> ');if(d.length>0){l.push('<a href="javascript:;" class="box-ok" id="not_use_coupon_btn_'+m+'" onclick="ec.order.proxy.couponNotUse(\''+m+'\')"><span id="not_use_coupon_text">\u4e0d\u4f7f\u7528\u4f18\u60e0\u5238</span></a> ');l.push('<a href="javascript:;" class="box-sure" id="use_coupon_btn_'+m+'" onclick="ec.order.proxy.couponUse(this,\''+m+"')\"><span>\u7acb\u5373\u4f7f\u7528</span></a> ")}else{l.push('<a href="javascript:;" class="box-ok"  id="close_use_coupon_btn" ><span>\u5173\u95ed</span></a>')}l.push("     	</div> ");l.push("     </div> ");l.push("     <!--\u4f18\u60e0\u5238\u5217\u8868end--> ");l.push("     <!--\u4f18\u60e0\u5238\u7801\u64cd\u4f5c\u533astart--> ");l.push('     <div id="order-roll-code-'+m+'"> ');l.push('         <div class="order-rollcode hide"> ');l.push('             <ul class="clearfix"> ');l.push("                <li>\u4f18\u60e0\u5238\u7801</li> ");l.push("                 <li> ");l.push('                     <input type="text" id="couponCodeOnly-'+m+'" class="text vam span-150" /> ');l.push('                    <div id="couponCodeProxy-report-errors-'+m+'"></div> ');l.push("                </li> ");l.push('                <li><a href="javascript:;" onclick="ec.order.proxy.addCouponOnly(\''+m+"');\">\u786e\u8ba4</a></li> ");l.push("             </ul> ");l.push('             <div id="coupon-code-div-'+m+'" class="hide"> ');l.push('                <div class="order-roll-detail current" id="li_coupon-'+m+'"></div> ');l.push("            </div> ");l.push("        </div> ");l.push('         <div class="box-button hide"> ');l.push('            <a href="javascript:;" class="box-ok" id="code_not_use_coupon_btn_'+m+'" onclick="ec.order.proxy.couponNotUse(\''+m+'\')"><span id="not_use_coupon_text">\u4e0d\u4f7f\u7528\u4f18\u60e0\u5238</span></a> ');l.push('             <a href="javascript:;" class="box-sure disabled" id="code_use_coupon_btn_'+m+'" onclick="ec.order.proxy.couponUse(this,\''+m+"')\"><span>\u7acb\u5373\u4f7f\u7528</span></a> ");l.push("         </div> ");l.push("     </div> ");l.push(" </div> ");l.push(" <!--\u4f18\u60e0\u5238\u7801\u64cd\u4f5c\u533aend--> ");var l='<ul class="clearfix">'+l.join(" ")+"</ul>";$("#order-coupon-tpl-"+m).val(l)}})};ec.order.proxy.couponRender=function(c,b,a){$("input[id^='coupon-first-']").each(function(){if($(this).val()!=undefined&&$(this).val()!=""){var e=$(this).val().split("|");if(e[0]!=a&&e[1]==c.split("|")[1]){$("#couponCodeProxy-report-errors-"+a).html("\u4f18\u60e0\u5238\u5df2\u88ab\u4f7f\u7528\uff01");return}}});if(b[a].effectiveList){var d="";jQuery.each(b[a].effectiveList,function(j,e){if(c.split("|")[1]==e.couponCode){var g="";var m="";var n="";if((e.ruleType==1||e.amount!=null)&&e.deliveryFree==0){if(parseInt(e.amount)==e.amount){g="<span>"+parseInt(e.amount)+"</span><strong>\u4f18\u60e0\u5238</strong>"}else{g="<span>"+e.amount.toFixed(2)+"</span><strong>\u4f18\u60e0\u5238</strong>"}m="<em>&yen;</em>"}else{if((e.ruleType==2||e.discount!=null)&&e.deliveryFree==0){n=" order-roll-discount";g="<span>"+e.discount*10+"</span><b>\u6298</b>"}else{n=" order-roll-type";g="<span>\u514d\u90ae\u5238</span>"}}var k=e.couponName;var l=b[a].couponDeduct||0;var f=[];f.push('<div class="order-roll-info">');f.push(m);f.push('<div class="order-roll-price clearfix">');f.push(g);f.push("</div>");f.push('<p title="'+k+'" class="order-roll-word">'+k+"</p>");f.push("</div>");if(e.couponDes!=null){f.push('<p class="order-roll-explain">\u4f7f\u7528\u8981\u6c42\uff1a'+e.beginDate.substring(0,10).replaceAll("-",".")+" - "+e.endDate.substring(0,10).replaceAll("-",".")+"\uff0c"+e.couponDes)}else{f.push('<p class="order-roll-explain">\u4f7f\u7528\u8981\u6c42\uff1a'+e.beginDate.substring(0,10).replaceAll("-",".")+" - "+e.endDate.substring(0,10).replaceAll("-","."))}f.push('<a href="javascript:;" class="btn"></p>');var e=f.join("");$("#li_coupon-"+a).html(e);$("#li_coupon-"+a).removeClass("order-roll-discount");$("#li_coupon-"+a).removeClass("order-roll-type");$("#li_coupon-"+a).addClass(n);$("#li_coupon-"+a).attr("code",c.split("|")[1]);var h=c.split("|")[1]+"|"+k+"|"+l;$("#li_coupon-"+a).attr("data",h);cache_proxyCoupon_by_inputCode={};cache_proxyCoupon_by_inputCode.coupon=e;cache_proxyCoupon_by_inputCode.code=c.split("|")[1];cache_proxyCoupon_by_inputCode.data=h;cache_proxyCoupon_by_inputCode.couponStyle=n;allProxyCouponCache[a]=cache_proxyCoupon_by_inputCode;$("#coupon-code-div-"+a).show();return}})}};ec.order.proxy.couponUse=function(c,a){if($(c).hasClass("disabled")){return}var b="";var d="";if($("#coupon_tab_"+a).attr("class")=="current"){allProxyCouponCache[a]=null;b=$("#order-roll-coupon-"+a+" li.order-roll-detail.current").attr("id");d=$("#"+b).attr("data")}else{$("li[index^='"+a+"effCouponInfo_']").removeClass("current");b=$("#li_coupon-"+a).attr("code");d=$("#li_coupon-"+a).attr("data")}ec.order.proxy.addCoupon(a+"|"+b,{type:"coupon",shopCode:a,couponData:d});$("#coupon-edit-link-"+a).removeClass("hide");$("#coupon-use-link-"+a).addClass("hide");$(".ol_box_mask").addClass("hide");$("#order-coupon-box").addClass("hide")};ec.order.proxy.couponNotUse=function(a){$("#li_coupon-"+a).removeClass("current");allProxyCouponCache[a]=null;$("#coupon-edit-link-"+a).addClass("hide");$("#coupon-use-link-"+a).removeClass("hide");ec.order.proxy.addCoupon("",{shopCode:a,errorFunction:function(){}})};ec.order.proxy.couponTabChange=function(b,a){if(b=="coupon_tab"){$("#coupon_tab_"+a).addClass("current");$("#coupon_code_tab_"+a).removeClass("current");$("#order-roll-coupon-"+a+">:first").removeClass("hide");$("#order-roll-coupon-"+a+">:eq(1)").removeClass("hide");$("#order-roll-code-"+a+">:first").addClass("hide");$("#order-roll-code-"+a+">:eq(1)").addClass("hide");if($("li[name^='"+a+"effCouponInfo_']").hasClass("current")){$("#use_coupon_btn_"+a).removeClass("disabled")}else{$("#use_coupon_btn_"+a).addClass("disabled");$("li[name^='"+a+"effCouponInfo_']").removeClass("current")}}else{if(b=="coupon_code_tab"){$("#coupon_tab_"+a).removeClass("current");$("#coupon_code_tab_"+a).addClass("current");$("#order-roll-coupon-"+a+">:first").addClass("hide");$("#order-roll-coupon-"+a+">:eq(1)").addClass("hide");$("#order-roll-code-"+a+">:first").removeClass("hide");$("#order-roll-code-"+a+">:eq(1)").removeClass("hide")}}};ec.order.proxy.resetCoupon=function(a){$("#proxyCoupon"+a).val("");$("#coupon-first-"+a).val("")};ec.order.proxy.openPopWindow=function(g,f,c,b,h,a){var d=new ec.box($("#"+g).val(),{boxclass:"ol_box_4",boxid:f,title:h,width:c,modal:true,showButton:false,autoHeight:false,height:b,onok:function(i){i.close()}}).open();if("order-coupon-tpl-"+a==g){var e="";if($("#coupon-first-"+a).val()!=undefined&&$("#coupon-first-"+a).val()!=""){e=$("#coupon-first-"+a).val().split("|")[1]}if(!e||e==""){$("#code_use_coupon_btn_"+a).unbind("click");$("#code_use_coupon_btn_"+a).addClass("disabled");$("#use_coupon_btn_"+a).unbind("click");$("#use_coupon_btn_"+a).addClass("disabled");$("li[index^='"+a+"effCouponInfo_']").removeClass("current")}else{if(allProxyCouponCache[a]){$("#li_coupon-"+a).addClass("current");$("li[index^='"+a+"effCouponInfo_']").removeClass("current")}else{$("#"+e).addClass("current").siblings().removeClass("current")}}if(allProxyCouponCache!=null&&allProxyCouponCache[a]){$("#li_coupon-"+a).html(allProxyCouponCache[a].coupon);$("#li_coupon-"+a).attr("code",allProxyCouponCache[a].code);$("#li_coupon-"+a).attr("data",allProxyCouponCache[a].data);$("#li_coupon-"+a).removeClass("order-roll-discount");$("#li_coupon-"+a).removeClass("order-roll-type");$("#li_coupon-"+a).addClass(allProxyCouponCache[a].couponStyle);$("#couponCodeOnly-"+a).val(allProxyCouponCache[a].code);ec.order.proxy.couponTabChange("coupon_code_tab",a);$("#code_use_coupon_btn_"+a).removeClass("disabled");$("#coupon-code-div-"+a).show()}}$(".order-roll-explain").each(function(){if($(this).height()>18){$(this).addClass("order-roll-explain-more");$(this).children("a").removeClass("hide");$(this).bind("click",function(){if($(this).attr("class").indexOf("order-roll-explain-open")==-1){$(this).addClass("order-roll-explain-open")}else{$(this).removeClass("order-roll-explain-open")}})}})};ec.order.proxy.couponSelected=function(b,a){$("#use_coupon_btn_"+a).removeClass("disabled");$("#"+b).addClass("current").siblings().removeClass("current")};ec.order.proxy.ecboxOpen=function(a){new ec.box($("#order-confim-box-tpl").val().replace("msg",a),{boxclass:"ol_box_4",boxid:"show_msg_box",width:700,modal:true,showButton:false,onok:function(b){b.close()}}).open()};
