ec.pkg("ec.member.add");ec.load("RaterStar");ec.load("ajax",{loadType:"lazy"});ec.load("ec.box",{loadType:"lazy"});ec.member.add.getPrdInfoBySkucode=function(){var a=$("#commodity-skuCode").attr("value");if(a==undefined){return}if(a!=""){new ec.ajax().get({url:pmsHttpDomain+"product/querySbomInfoByCode.json?sbomCode="+a,dataType:"jsonp",timeout:10000,successFunction:function(d){var e;for(var c=0;c<d.data.length;c++){e=d.data[c];if((a==e.sbomCode)&&(e.prdId!=null)){$("#remark-a-prdimg").attr("href","/product/"+e.prdId+".html#"+e.sbomId);var b=$("#globleParameter").attr("mediaPath");$("#remark-a-prdimg").children("img").attr("src",ec.mediaPath+e.photoPath+"142_142_"+e.photoName);$("#remark-a-prdname").attr("href","/product/"+e.prdId+".html#"+e.sbomId);$("#remark-a-prdname").html(e.name)}}}})}};var _remarkPrivate={showError:function(a){$("#error-area").show();$("#error-span").html(a)},hideError:function(){$("#error-area").hide()},getSelectedLen:function(){return $(".ce-post-impress-item.selected").length},getSelectedDiyLen:function(){return $(".tag-li-diy-item.selected").length},check:function(){this.hideError();var a=ec.util.trim($("#tag-input").val());if(a.length==0||a===$("#tag-input").attr("placeholder")){this.showError("\u8f93\u5165\u4e0d\u80fd\u4e3a\u7a7a");return false}if(/\s/.test(a)){this.showError("\u6807\u7b7e\u4e2d\u4e0d\u53ef\u4ee5\u6709\u7a7a\u683c");return false}if(a.len()>=13){this.showError("\u6807\u7b7e\u4e0d\u53ef\u4ee5\u8d85\u8fc76\u4e2a\u6c49\u5b57");return false}return true}};ec.member.add.tagOnclick=function(c){var d=_remarkPrivate.getSelectedLen();var a=_remarkPrivate.getSelectedDiyLen();if(d>=5&&!$(c).hasClass("selected")){_remarkPrivate.showError("\u6700\u591a\u53ea\u80fd\u9009\u62e95\u4e2a\u6807\u7b7e\u54e6\uff0c\u597d\u597d\u60f3\u60f3\u9009\u4ec0\u4e48\u5427~")}else{if(a>=4&&!$(c).hasClass("selected")&&$(c).hasClass("tag-li-diy-item")){_remarkPrivate.showError("\u6700\u591a\u53ea\u80fd\u81ea\u5b9a\u4e494\u4e2a\u6807\u7b7e\u54e6\uff0c\u597d\u597d\u60f3\u60f3\u5199\u4ec0\u4e48\u5427~")}else{_remarkPrivate.hideError();$(c).toggleClass("selected");var b=$(c).find("input")[0];if(b){if(b.checked){b.checked=false}else{b.checked=true}}}}};ec.member.add.diyOnclick=function(b){var c=_remarkPrivate.getSelectedLen();var a=_remarkPrivate.getSelectedDiyLen();if(c>=5){_remarkPrivate.showError("\u6700\u591a\u53ea\u80fd\u9009\u62e95\u4e2a\u6807\u7b7e\u54e6\uff0c\u597d\u597d\u60f3\u60f3\u9009\u4ec0\u4e48\u5427~")}else{if(a>=4){_remarkPrivate.showError("\u6700\u591a\u53ea\u80fd\u81ea\u5b9a\u4e494\u4e2a\u6807\u7b7e\u54e6\uff0c\u597d\u597d\u60f3\u60f3\u5199\u4ec0\u4e48\u5427~")}else{$("#diy-area").addClass("current")}}};ec.member.add.addTag=function(){$("#form-submit-error").html("");var b=_remarkPrivate.getSelectedLen();var a=_remarkPrivate.getSelectedDiyLen();if(b>=5){_remarkPrivate.showError("\u6700\u591a\u53ea\u80fd\u9009\u62e95\u4e2a\u6807\u7b7e\u54e6\uff0c\u597d\u597d\u60f3\u60f3\u9009\u4ec0\u4e48\u5427~")}else{if(a>=4){_remarkPrivate.showError("\u6700\u591a\u53ea\u80fd\u81ea\u5b9a\u4e494\u4e2a\u6807\u7b7e\u54e6\uff0c\u597d\u597d\u60f3\u60f3\u5199\u4ec0\u4e48\u5427~")}else{if(_remarkPrivate.check()){$("<li class='ce-post-impress-item tag-li-diy-item' onclick='ec.member.add.tagOnclick(this);'><div class='impress'><input type='checkbox' checked='true' name='diyTags' style='visibility: hidden; position: absolute;' value='"+ec.util.trim($("#tag-input").val())+"' id='diyTags'></input><a href='javascript:;'>"+ec.util.trim($("#tag-input").val())+"</a><s></s></div></li>").insertBefore($("#diy-area")).addClass("selected");$("#tag-input").val("");if(_remarkPrivate.getSelectedLen()>=5){$("#diy-area").removeClass("current")}}}}};ec.member.add.submit=function(e){$(e).find(".button-action-pay").attr("disabled","disabled");var m=$("#commodity-content").val(),l=m.len();if($(".selected").length==0){$("#form-submit-error").html("\u8bf7\u7ed9\u5546\u54c1\u6253\u51e0\u4e2a\u6807\u7b7e");$("#form-submit-error").removeClass("hide");$(e).find(".button-action-pay").attr("disabled","");return false}if(ec.util.isEmpty(m)||m===$("#commodity-content").attr("placeholder")){$("#form-submit-error").html("\u8bf7\u5199\u70b9\u8bc4\u4ef7\u5427\uff01");$("#commodity-content").addClass("error");$("#commodity-content").next("label").remove();$("#commodity-content").after("<label class='label-error vat'></label>");$("#form-submit-error").removeClass("hide");$(e).find(".button-action-pay").attr("disabled","");return false}if(l<1||l>1000){$("#form-submit-error").html("\u9ebb\u70e6\u586b\u51991-500\u4e2a\u5b57\u54df");$("#form-submit-error").removeClass("hide");$("#commodity-content").addClass("error");$("#commodity-content").next("label").remove();$("#commodity-content").after("<label class='label-error vat'></label>");$(e).find(".button-action-pay").attr("disabled","");return false}var k=$(".tag-li-fromserver-item");var o=$(".ce-post-impress-item.tag-li-diy-item.selected");for(var h=0,l=o.length;h<l;h++){var f=$(o.get(h));var d=f.find("a").text();if(f.find("input")[0].checked){$(".tag-li-fromserver-item").each(function(){if($.trim($(this).find("a").text())===d){$(this).find("input")[0].checked=true;f.find("input")[0].checked=false}});for(var g=l;g>h;g--){var n=$(o.get(g));var q=n.find("a").text();if(d===q){n.find("input")[0].checked=false}}}}var p=$(e);var b=$("#commodity-id").val();var a="";if(ec.util.isEmpty(b)){a=domainRemark+"/remark/addUserRemark.json?t="+new Date().getTime()}else{a=domainRemark+"/remark/modifyUserRemark.json?t="+new Date().getTime();a+="&id="+$("input[name=id]",p).val()}a+="&productId="+$("input[name=productId]",p).val();a+="&orderCode="+$("input[name=orderCode]",p).val();a+="&skuCode="+$("input[name=skuCode]",p).val();a+="&score="+$("input[name=score]",p).val();a+="&isHisData="+$("input[name=isHisData]",p).val();a+="&channel=1";$("input[name=tags]",p).each(function(){if(this.checked){a+="&tags="+encodeURIComponent(this.value)}});$("input[name=diyTags]",p).each(function(){if(this.checked){a+="&diyTags="+encodeURIComponent(this.value)}});$("input[name=isanonymous]",p).each(function(){if(this.checked){a+="&isanonymous="+encodeURIComponent(this.value)}});a+="&content="+encodeURIComponent($("#commodity-content",p).val());new ec.ajax().get({url:a,dataType:"jsonp",timeout:10000,timeoutFunction:function(){alert("\u4fdd\u5b58\u8d85\u65f6\uff0c\u8bf7\u91cd\u8bd5\uff01")},beforeSendFunction:ec.ui.loading.show,afterSendFunction:ec.ui.loading.hide,successFunction:function(c){if(!c.success){ec.showError(c);$(e).find(".button-action-pay").attr("disabled","");return}else{if(!ec.util.isEmpty(b)){ec.member.add.saveUpdateRecord(e)}}new ec.box($("#box-success-add").val(),{boxid:"success_add_box",boxclass:"ol_box_4",showTitle:true,showCancel:false,width:428,timeout:2000,onclose:function(i){window.location.href="/member/prdRemarkView"},onok:function(i){window.location.href="/member/prdRemarkView"}}).open()},errorFunction:function(c){alert("\u4fdd\u5b58\u8d85\u65f6\uff0c\u8bf7\u91cd\u8bd5\uff01");$(e).find(".button-action-pay").attr("disabled","")}});return false};ec.member.add.showView=function(){var h=document,b="placeholder" in h.createElement("input"),g=function(k){$(k).addClass("commodity-input-color-999");var l=k.getAttribute("placeholder"),i=k.defaultValue;if(i==""){k.value=l}k.onfocus=function(){$(k).removeClass("commodity-input-color-999");if(k.value===l){this.value=""}};k.onblur=function(){if(k.value===""){this.value=l;$(k).addClass("commodity-input-color-999")}else{$(k).removeClass("commodity-input-color-999")}}};if(!b){var a=[document.getElementsByTagName("textarea"),document.getElementsByTagName("input")];for(var c=0;c<2;c++){var d=a[c];for(var e=0;e<d.length;e++){var f=d[e],j=f.getAttribute("placeholder");if((f.type==="text"||f.type==="textarea")&&j){g(f)}}}}$("#ct-star").rater({min:1,max:5,width:30,height:22,image:imagePath+"/echannel/star/star10.png",value:$("#commodity-score").val(),after_click:function(i){$("#commodity-score").val(i.number)}});ec.form.input.wordCount("#commodity-content",{max:1,callback:function(i){$("#commodity-word-count").html(i+"/500");if(i>500){$("#form-submit-error").html("\u9ebb\u70e6\u586b\u51991-500\u4e2a\u5b57\u54df");$("#form-submit-error").removeClass("hide");$("#commodity-content").addClass("error");$("#commodity-content").next("label").remove();$("#commodity-content").after("<label class='label-error vat'></label>")}else{$("#form-submit-error").addClass("hide");$("#form-submit-error").html("");$("#commodity-content").removeClass("error");$("#commodity-content").next(".label-error").remove()}}});$("#li-prdRemark").addClass("current");$("#pathTitle").html("\u5546\u54c1\u8bc4\u4ef7");ec.form.validator.bind("#commodity-content",{type:["require","length","forbidChar"],validOnChange:true,min:1,max:500,autoFocus:true,msg:{"default":""}});ec.member.add.getPrdInfoBySkucode()};$.extend(ec.form.validator.defaults,{errorClass:"error",autoFocus:false,errorFunction:function(c,a){var b="label-error",d=a.msg[a.type]||a.msg["default"];d=(d.length<=0)?"&nbsp;":d;switch(a.type){case"require":b="label-error";break}if(a.msg_ct){$(a.msg_ct).addClass("label-error").html(d)}else{var e=(c.attr("id")||c.attr("name"))+"-msg";$("#"+e).remove();c.after("<label id='"+e+"' class='label-error "+b+"'>"+d+"</label>");$("#commodity-content-msg").addClass("vat")}if(a.autoFocus){c.focus()}},successFunction:function(b,a){if(a.msg_ct){$(a.msg_ct).html("").removeClass("label-error")}else{$("#"+(b.attr("id")||b.attr("name"))+"-msg").remove()}}});ec.member.add.saveUpdateRecord=function(c){var m=$(c);var a=$("input[name=id]",m).val();var k=$("input[name=skuCode]",m).val();var f=encodeURIComponent($("#remark-a-prdname",m).text());var e=$("input[name=orderCode]",m).val();var g=$("input[name=oldScore]",m).val();var j=encodeURIComponent($("input[name=oldContent]",m).val());var i=$("input[name=score]",m).val();var l=encodeURIComponent($("#commodity-content",m).val());var h="";var d="";$("input[name=oldLableList]",m).each(function(){h+=$(this).val()+("  ")});$("input[name=tags]",m).each(function(){if(this.checked){d+=$(this).siblings("a").eq(0).text()+("  ")}});$("input[name=diyTags]",m).each(function(){if(this.checked){d+=$(this).val()+("  ")}});d=encodeURIComponent(d);h=encodeURIComponent(h);var b="/member/prdRemark/addUpdateRecord.json?t="+new Date().getTime();b+="&remarkId="+a;b+="&skuCode="+k;b+="&prdSkuName="+f;b+="&orderCode="+e;b+="&oldScore="+g;b+="&oldContent="+j;b+="&newScore="+i;b+="&newContent="+l;b+="&oldLabelJson="+h;b+="&newLabelJson="+d;new ec.ajax().post({url:b,timeout:5000})};
